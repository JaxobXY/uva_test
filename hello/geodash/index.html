<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neon Dash</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: radial-gradient(circle at center, #000428 0%, #004e92 50%, #000428 100%);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Courier New", monospace;
        }
        canvas {
            background: linear-gradient(to bottom, #0a0a2e 0%, #1a0033 70%, #000428 100%);
            border: 4px solid #00ffff;
            box-shadow: 0 0 50px #00ffff, inset 0 0 50px rgba(0,255,255,0.1);
            image-rendering: pixelated;
            display: block;
            width: 100vw;
            height: 100vh;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ffff;
            font-size: 24px;
            text-shadow: 0 0 10px #00ffff;
            z-index: 100;
            pointer-events: none;
        }
        #fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,255,255,0.2);
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            text-shadow: 0 0 5px #00ffff;
            transition: all 0.3s;
            z-index: 100;
        }
        #fullscreen-btn:hover {
            background: rgba(0,255,255,0.4);
            box-shadow: 0 0 20px #00ffff;
        }
        #progress-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw;
            max-width: 800px;
            height: 12px;
            background: rgba(0,0,0,0.5);
            border: 3px solid #00ffff;
            border-radius: 6px;
            box-shadow: 0 0 30px rgba(0,255,255,0.3);
            z-index: 100;
            pointer-events: none;
            display: none;
        }
        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0080);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
            box-shadow: 0 0 25px #00ff00;
        }

        /* MAIN MENU */
        #main-menu {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff;
            z-index: 200;
        }
        #main-title {
            font-size: 64px;
            letter-spacing: 6px;
            margin-bottom: 40px;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }
        @keyframes titleGlow {
            from { text-shadow: 0 0 20px #00ffff; }
            to   { text-shadow: 0 0 40px #00ffff, 0 0 60px #00ffff; }
        }
        #center-row {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }
        .center-btn {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            border: 4px solid #00ffff;
            background: rgba(0,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0,255,255,0.4);
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            font-size: 40px;
        }
        .center-btn:hover {
            transform: scale(1.1);
            background: rgba(0,255,255,0.35);
            box-shadow: 0 0 30px rgba(0,255,255,0.7);
        }
        #play-btn { font-size: 48px; }
        #bottom-row {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        .bottom-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #00ffff;
            background: rgba(0,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0,255,255,0.4);
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            font-size: 28px;
        }
        .bottom-btn:hover {
            transform: scale(1.1);
            background: rgba(0,255,255,0.35);
            box-shadow: 0 0 25px rgba(0,255,255,0.7);
        }

        .overlay-panel {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            z-index: 220;
        }
        .overlay-panel h2 { font-size: 40px; margin-bottom: 20px; }
        .overlay-panel button {
            margin-top: 20px;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
            background: rgba(0,255,255,0.2);
            color: #00ffff;
            font-family: inherit;
            cursor: pointer;
            font-size: 18px;
        }

        /* LEVEL SELECT */
        #level-select {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            z-index: 210;
        }
        #level-card {
            background: rgba(255,0,128,0.9);
            border-radius: 20px;
            padding: 25px 40px;
            box-shadow: 0 0 30px rgba(255,0,128,0.8);
            text-align: center;
            min-width: 360px;
        }
        #level-name { font-size: 32px; margin-bottom: 10px; }
        #mode-lines { margin-top: 10px; font-size: 18px; }
        #level-select-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        #level-play-btn {
            padding: 10px 30px;
            border-radius: 10px;
            border: 3px solid #ffffff;
            background: rgba(0,255,0,0.7);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 20px;
        }
        .level-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 80px;
            border-radius: 20px;
            border: 3px solid #ffffff;
            background: rgba(255,255,255,0.15);
            color: #ffffff;
            cursor: pointer;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }
        #level-prev { left: 40px; }
        #level-next { right: 40px; }

        #level-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff00;
            font-size: 48px;
            text-align: center;
            text-shadow: 0 0 30px #00ff00;
            letter-spacing: 6px;
            z-index: 150;
            pointer-events: none;
            opacity: 0;
            display: none;
            animation: levelCompletePulse 1s ease-in-out infinite;
        }
        @keyframes levelCompletePulse {
            0%,100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50%     {
            opacity: 1;   transform: translate(-50%, -50%) scale(1.15); }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="ui">
        <div>WORLD: <span id="worldDisplay">1</span></div>
        <div>LEVEL: <span id="levelDisplay">1</span></div>
        <div>SCORE: <span id="scoreDisplay">0</span></div>
    </div>

    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <button id="fullscreen-btn">FULLSCREEN</button>

    <!-- MAIN MENU -->
    <div id="main-menu">
        <div id="main-title">NEON DASH</div>
        <div>Click / Space to Jump</div>

        <div id="center-row">
            <div class="center-btn" id="icon-btn">üôÇ</div>
            <div class="center-btn" id="play-btn">‚ñ∂</div>
            <div class="center-btn" id="editor-btn">üõ†</div>
        </div>

        <div id="bottom-row">
            <div class="bottom-btn" id="achievements-btn">üèÜ</div>
            <div class="bottom-btn" id="settings-btn">‚öô</div>
        </div>
    </div>

    <!-- Simple panels -->
    <div id="achievements-panel" class="overlay-panel">
        <h2>Achievements</h2>
        <p>Complete levels to unlock more.</p>
        <button onclick="closeOverlay('achievements-panel')">Close</button>
    </div>
    <div id="settings-panel" class="overlay-panel">
        <h2>Settings</h2>
        <p>Volume / graphics toggles can go here.</p>
        <button onclick="closeOverlay('settings-panel')">Close</button>
    </div>
    <div id="icon-panel" class="overlay-panel">
        <h2>Icons</h2>
        <p>Customization coming soon.</p>
        <button onclick="closeOverlay('icon-panel')">Close</button>
    </div>
    <div id="editor-panel" class="overlay-panel">
        <h2>Editor</h2>
        <p>Custom levels coming later.</p>
        <button onclick="closeOverlay('editor-panel')">Close</button>
    </div>

    <!-- LEVEL SELECT -->
    <div id="level-select">
        <button id="level-prev" class="level-arrow">&lt;</button>
        <div id="level-card">
            <div id="level-name">LEVEL 1</div>
            <div id="mode-lines">
                <div>Normal Mode 0%</div>
                <div>Practice Mode 0%</div>
            </div>
            <div id="level-select-buttons">
                <button id="level-play-btn">PLAY</button>
            </div>
        </div>
        <button id="level-next" class="level-arrow">&gt;</button>
    </div>

    <div id="level-complete">LEVEL COMPLETE!</div>

    <script src="worldData.js"></script>
    <script src="collision.js"></script>
    <script src="display.js"></script>
    
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // DOM Elements
        const ui = document.getElementById('ui');
        const worldDisplay = document.getElementById('worldDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');

        const mainMenu = document.getElementById('main-menu');
        const achievementsPanel = document.getElementById('achievements-panel');
        const settingsPanel = document.getElementById('settings-panel');
        const iconPanel = document.getElementById('icon-panel');
        const editorPanel = document.getElementById('editor-panel');

        const levelSelect = document.getElementById('level-select');
        const levelNameEl = document.getElementById('level-name');
        const levelPrevBtn = document.getElementById('level-prev');
        const levelNextBtn = document.getElementById('level-next');
        const levelPlayBtn = document.getElementById('level-play-btn');

        const levelCompleteMsg = document.getElementById('level-complete');

        // FIXED: Define LEVELS early (after worldData.js loads)
        const LEVELS = GAME_DATA.worlds[0].levels.map(l => ({ id: l.id, name: l.name }));

        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        });

        const CUBE_SIZE = 40;
        const SCROLL_SPEED_BASE = 8;
        let GROUND_Y = canvas.height - 100;

        let gameState = 'menu';
        let currentLevelIndex = 0;
        let selectedLevelIndex = 0;
        let scrollOffset = 0;
        let scrollSpeed = SCROLL_SPEED_BASE;
        let score = 0;
        let levelLength = 0;

        let levelObjects = [];
        const player = {
            x: 0,
            y: 0,
            size: CUBE_SIZE,
            velocity: 0,
            gravity: 0.876,
            jumpPower: -12.5,
            onGround: false
        };

        let particles = [];
        window.particles = particles;

        function createEpicExplosion(x, y) {
            for (let i = 0; i < 200; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 35,
                    vy: (Math.random() - 0.5) * 35 - 12,
                    life: 1.0,
                    size: Math.random() * 15 + 8,
                    color: ['#ff0080','#00ff00','#ffff00','#ff00ff','#00ffff','#ffffff'][Math.floor(Math.random()*6)]
                });
            }
        }

        function updateParticles() {
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.5;
                p.life -= 0.02;
                p.size *= 0.96;
                return p.life > 0;
            });
        }

        function getPlatforms() {
            return levelObjects.filter(o => o.type === 'platform');
        }

        function updateProgressBar() {
            const playerWorldX = scrollOffset + player.x;
            const progress = Math.min((playerWorldX / levelLength) * 100, 100);
            progressBar.style.width = progress + '%';
        }

        function loadLevel(levelIdx) {
            const level = GAME_DATA.worlds[0].levels[levelIdx];
            GROUND_Y = canvas.height - 100;

            scrollOffset = 0;
            scrollSpeed  = SCROLL_SPEED_BASE;
            score        = 0;
            particles    = [];

            levelObjects = level.objects.map(obj => {
                const copy = { ...obj };
                if (copy.type === 'platform') {
                    copy.y = GROUND_Y - copy.yOffset;
                }
                if (copy.type === 'spike' && copy.y === 0) {
                    const nearestPlatform = level.objects.find(
                        p => p.type === 'platform' && Math.abs(p.x - copy.x) < 100
                    );
                    copy.platformY = nearestPlatform
                        ? GROUND_Y - nearestPlatform.yOffset
                        : GROUND_Y;
                }
                return copy;
            });

            levelLength = level.endX;

            const firstPlatform = levelObjects.find(o => o.type === 'platform');
            player.x = canvas.width / 3;
            player.y = (firstPlatform ? firstPlatform.y : GROUND_Y) - player.size;
            player.velocity = 0;
            player.onGround = false;

            worldDisplay.textContent = 1;
            levelDisplay.textContent = level.id;
            scoreDisplay.textContent = '0';

            levelCompleteMsg.style.display = 'none';
            levelCompleteMsg.style.opacity = '0';

            updateProgressBar();
        }

        function showMainMenu() {
            gameState = 'menu';
            mainMenu.style.display = 'flex';
            levelSelect.style.display = 'none';
            ui.style.display = 'none';
            progressContainer.style.display = 'none';
            levelCompleteMsg.style.display = 'none';
        }

        function openOverlay(id) {
            document.getElementById(id).style.display = 'flex';
        }
        function closeOverlay(id) {
            document.getElementById(id).style.display = 'none';
        }
        window.closeOverlay = closeOverlay;

        // Event handlers
        document.getElementById('icon-btn').onclick        = () => openOverlay('icon-panel');
        document.getElementById('editor-btn').onclick      = () => openOverlay('editor-panel');
        document.getElementById('achievements-btn').onclick = () => openOverlay('achievements-panel');
        document.getElementById('settings-btn').onclick    = () => openOverlay('settings-panel');

        // FIXED Level Select
        document.getElementById('play-btn').onclick = () => {
            gameState = 'levelSelect';
            mainMenu.style.display = 'none';
            levelSelect.style.display = 'flex';
            selectedLevelIndex = 0;
            updateLevelCard();
        };

        function updateLevelCard() {
            if (!LEVELS || selectedLevelIndex >= LEVELS.length) return;
            const lvl = LEVELS[selectedLevelIndex];
            levelNameEl.textContent = lvl.name;
        }

        levelPrevBtn.onclick = () => {
            selectedLevelIndex = (selectedLevelIndex - 1 + LEVELS.length) % LEVELS.length;
            updateLevelCard();
        };
        levelNextBtn.onclick = () => {
            selectedLevelIndex = (selectedLevelIndex + 1) % LEVELS.length;
            updateLevelCard();
        };

        levelPlayBtn.onclick = () => {
            currentLevelIndex = selectedLevelIndex;
            levelSelect.style.display = 'none';
            ui.style.display = 'block';
            progressContainer.style.display = 'block';
            gameState = 'playing';
            loadLevel(currentLevelIndex);
            requestAnimationFrame(update);
        };

        function update() {
            if (gameState !== 'playing') return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            GROUND_Y = canvas.height - 100;

            scrollOffset += scrollSpeed;
            player.x = canvas.width / 3;
            player.velocity += player.gravity;
            player.y += player.velocity;

            const platforms = getPlatforms();

            handlePlatformCollisions(
                player,
                platforms,
                scrollOffset,
                GROUND_Y,
                canvas.height,
                () => {
                    const playerWorldX = scrollOffset + player.x;
                    if (playerWorldX < levelLength && gameState === 'playing') {
                        gameState = 'dead';
                        createEpicExplosion(player.x, player.y);
                        setTimeout(showMainMenu, 2000);
                    }
                }
            );

            if (gameState !== 'playing') {
                updateParticles();
                drawBackgroundGrid(ctx, canvas);
                drawPlatforms(ctx, platforms, scrollOffset);
                drawPlatformEdges(ctx, platforms, scrollOffset);
                drawPlayer(ctx, player);
                drawSpikes(ctx, levelObjects, scrollOffset, GROUND_Y, CUBE_SIZE);
                drawParticles(ctx);
                return;
            }

            if (handleSpikeCollisions(player, levelObjects, scrollOffset, GROUND_Y, CUBE_SIZE)) {
                gameState = 'dead';
                createEpicExplosion(player.x, player.y);
                setTimeout(showMainMenu, 2000);
                return;
            }

            updateParticles();
            drawBackgroundGrid(ctx, canvas);
            drawPlatforms(ctx, platforms, scrollOffset);
            drawPlatformEdges(ctx, platforms, scrollOffset);
            drawPlayer(ctx, player);
            drawSpikes(ctx, levelObjects, scrollOffset, GROUND_Y, CUBE_SIZE);
            drawParticles(ctx);
            updateProgressBar();

            const playerWorldX = scrollOffset + player.x;
            if (playerWorldX >= levelLength && gameState === 'playing') {
                gameState = 'levelComplete';
                createEpicExplosion(canvas.width / 2, canvas.height / 2);
                levelCompleteMsg.style.display = 'block';
                levelCompleteMsg.style.opacity = '1';
                setTimeout(showMainMenu, 2500);
                return;
            }

            score += scrollSpeed;
            scoreDisplay.textContent = Math.floor(score / 10);
            scrollSpeed = SCROLL_SPEED_BASE + (score / 1000) * 0.5;

            if (gameState === 'playing') requestAnimationFrame(update);
        }

        function jump() {
            if (gameState !== 'playing') return;
            if (player.onGround) {
                player.velocity = player.jumpPower;
                player.onGround = false;
            }
        }

        document.addEventListener('click', () => {
            if (gameState === 'playing') jump();
        });

        document.addEventListener('keydown', e => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (gameState === 'menu') {
                    document.getElementById('play-btn').click();
                } else if (gameState === 'levelSelect') {
                    levelPlayBtn.click();
                } else {
                    jump();
                }
            }
        });

        showMainMenu();
    </script>
</body>
</html>
